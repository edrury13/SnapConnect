# Deployment Notes for Render

## Fixing Build Errors

### Error 1: Python Version
- **Removed `runtime.txt`** - Render uses `.python-version` instead
- **Created `.python-version`** with `3.11.11`
- **Added `PYTHON_VERSION` env var** in `render.yaml` as backup

### Error 2: Rust Compilation (maturin)
The error occurs because some Python packages require Rust compilation, which fails on Render's read-only file system. 

**Problematic packages identified:**
- `uvicorn[standard]` - The `[standard]` extras include `watchfiles` which requires Rust
- `pinecone-client` - Has Rust dependencies
- Some sub-dependencies of `openai` package

**Solutions implemented:**
1. Removed `[standard]` from uvicorn (using plain `uvicorn==0.24.0`)
2. Temporarily disabled `openai` and `pinecone-client`
3. Made both services optional in the code with fallbacks

## Next Steps

1. **Deploy with minimal dependencies first** to ensure the service builds successfully
2. **Once deployed**, you can gradually add back dependencies:
   ```bash
   # In a future update, add these back to requirements.txt:
   langchain==0.1.0  # Use a newer stable version
   langchain-openai==0.0.5
   redis==5.0.1
   Pillow==10.1.0
   numpy==1.24.3
   ```

3. **For now, the LangChain features are disabled**. The basic embedding and search functionality will work without it.

## Current Status

**Both Pinecone and OpenAI have been temporarily disabled** in `requirements.txt` to avoid compilation errors on Render. The service will deploy and run in a limited mode:
- ✅ Basic API structure works
- ❌ No real embeddings (returns dummy data)
- ❌ No vector storage

This is just to get the deployment working. We'll add these back once confirmed.

## Deployment Steps

1. **Commit and push** the current changes
2. **Deploy on Render** - it should work now without the problematic dependency
3. **Test the basic endpoints** using the provided `test_deployment.py` script
4. **Add Pinecone later** once the basic deployment is stable

### Option 3: Use a Different Build Command
In Render dashboard, change the build command to:
```
pip install --only-binary :all: -r requirements.txt
```
This forces pip to only use pre-built wheels.

## Important Environment Variables

Make sure to set these in your Render dashboard:
- `OPENAI_API_KEY` - Your OpenAI API key
- `PINECONE_API_KEY` - Your Pinecone API key (optional initially)
- `PINECONE_ENVIRONMENT` - Your Pinecone region (e.g., "us-east-1" - NOT "us-east-1-aws")

The `API_KEY` will be auto-generated by Render for API authentication.

## Start Command

The start command is already configured in `render.yaml`:
```
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

Render will automatically use this command.

## Re-enabling Features After Deployment

Once your service is deployed and running, gradually add back features:

### Step 1: Add OpenAI (Required for embeddings)
```bash
# First try adding httpx (OpenAI dependency)
httpx==0.25.2

# Then add OpenAI
openai==1.12.0
```

### Step 2: Add Pinecone (For vector storage)
Try one of these approaches:
1. **Use pre-built wheels only:**
   ```bash
   pip install --only-binary :all: pinecone-client==3.0.0
   ```

2. **Try a different Pinecone version:**
   ```bash
   pinecone-client==2.2.2  # Older version might work
   ```

3. **Alternative: Use Docker deployment**
   Create a Dockerfile for full control over the build environment

4. **Alternative: Use a different vector database**
   - ChromaDB (pure Python, no compilation)
   - Weaviate (cloud option available)
   - Qdrant (cloud option available)

### Step 3: Add back uvicorn extras (Optional)
```bash
# Only if you need WebSocket support
uvicorn[standard]==0.24.0
``` 